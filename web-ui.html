<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Claude-like UI (Local Proxy)</title>

  <!-- PDF.js (PDF -> text in browser) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.js"></script>
  <!-- Mammoth.js (DOCX -> text in browser) -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

  <style>
    :root{
      --bg: #0b0c10;
      --panel: #0f1118;
      --panel2:#0d0f16;
      --border:#22263a;
      --text:#e9e9ef;
      --muted:#aab1d2;
      --muted2:#7e86ad;
      --accent:#7aa2ff;
      --danger:#b54b5a;
      --ok:#45c17c;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      --sans: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--sans);
    }

    /* App layout */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 300px 1fr;
    }
    @media (max-width: 920px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
    }

    /* Sidebar */
    .sidebar{
      background: #0a0b11;
      border-right:1px solid var(--border);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, #0f1118 0%, #0b0c10 100%);
      box-shadow: var(--shadow);
    }
    .logo{
      width:30px; height:30px; border-radius:10px;
      background: radial-gradient(circle at 30% 30%, #8ab4ff, #4b66ff);
      display:grid; place-items:center;
      font-weight:800;
    }
    .brand .title{ font-weight:700; }
    .brand .sub{ font-size:12px; color:var(--muted); margin-top:2px; }

    .btn{
      width:100%;
      border:1px solid var(--border);
      background: #111428;
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:hover{ border-color:#2f3760; }
    .btn.secondary{ background:#0f1118; }
    .btn.danger{ background:#241016; border-color:#4c1e28; color:#ffdfe5; }

    .search{
      display:flex; gap:8px;
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius: 12px;
      padding:8px 10px;
      align-items:center;
    }
    .search input{
      background:transparent; border:0; outline:none; color:var(--text);
      width:100%;
    }
    .sectionLabel{
      font-size:12px;
      color:var(--muted2);
      margin:4px 2px -4px;
    }

    .chatList{
      overflow:auto;
      flex:1;
      padding-right:4px;
    }
    .chatItem{
      padding:10px 10px;
      border:1px solid transparent;
      border-radius: 12px;
      cursor:pointer;
      margin:6px 0;
      background: transparent;
    }
    .chatItem:hover{ background:#0f1118; border-color:#1d2140; }
    .chatItem.active{ background:#111428; border-color:#2f3760; }
    .chatTitle{ font-weight:650; font-size:13px; }
    .chatMeta{ font-size:12px; color:var(--muted2); margin-top:4px; }

    .small{
      font-size:12px; color:var(--muted2); line-height:1.35;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--border);
      background:var(--panel2);
      padding:6px 10px;
      border-radius: 999px;
      font-size:12px;
      color:var(--muted);
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 18px;
      border-bottom:1px solid var(--border);
      background: rgba(15,17,24,.65);
      backdrop-filter: blur(10px);
    }
    .topbarLeft{
      display:flex; flex-direction:column;
      gap:2px;
    }
    .topTitle{ font-weight:750; }
    .topSub{ font-size:12px; color:var(--muted2); }

    .settingsRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width: 220px;
    }
    .field label{
      font-size:12px; color:var(--muted2);
    }
    .field input, .field select{
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
      width:100%;
    }
    .field input:focus, .field select:focus{ border-color:#3a4490; }

    .chat{
      flex:1;
      overflow:auto;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .bubble{
      max-width: 820px;
      width: fit-content;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: #0f1118;
      box-shadow: 0 6px 18px rgba(0,0,0,.20);
      line-height:1.45;
      white-space:pre-wrap;
      word-break: break-word;
    }
    .bubble.user{
      margin-left:auto;
      background:#111428;
      border-color:#2f3760;
    }
    .bubble.assistant{
      margin-right:auto;
      background:#0f1118;
    }
    .bubble .meta{
      font-size:12px; color:var(--muted2); margin-bottom:6px;
      display:flex; justify-content:space-between; gap:10px;
    }
    .code{
      font-family: var(--mono);
      background:#0b0d14;
      border:1px solid #20244a;
      padding:10px 12px;
      border-radius: 12px;
      margin-top:8px;
    }
    .hr{
      border-top:1px solid var(--border);
      margin:6px 0;
    }

    /* Composer */
    .composerWrap{
      border-top:1px solid var(--border);
      background: rgba(15,17,24,.75);
      backdrop-filter: blur(10px);
      padding:14px 18px;
    }
    .composer{
      max-width: 920px;
      margin:0 auto;
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius: 18px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:flex-end;
      box-shadow: var(--shadow);
    }
    .attachBtn{
      width:40px; height:40px;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#0b0d14;
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      flex: 0 0 auto;
      font-weight:900;
      font-size:18px;
    }
    .attachBtn:hover{ border-color:#3a4490; }

    textarea{
      flex:1;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      resize:none;
      min-height: 44px;
      max-height: 160px;
      font-size:14px;
      line-height:1.4;
      padding:8px 8px;
    }
    .composerRight{
      display:flex; gap:10px; align-items:center;
      flex: 0 0 auto;
    }
    .modelSelect{
      border:1px solid var(--border);
      background:#0b0d14;
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
      cursor:pointer;
    }
    .sendBtn{
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid #3140a2;
      background:#1a2a7a;
      color:#fff;
      cursor:pointer;
      font-weight:900;
      display:grid; place-items:center;
    }
    .sendBtn:disabled{ opacity:.55; cursor:not-allowed; }

    /* Attachments drawer */
    .attachPanel{
      max-width: 920px;
      margin:10px auto 0;
      border:1px solid var(--border);
      background: #0b0d14;
      border-radius: 14px;
      padding:10px 12px;
      display:none;
    }
    .attachPanel.show{ display:block; }
    .fileRow{
      display:flex; justify-content:space-between; gap:10px;
      padding:8px 10px;
      border:1px solid #1f2343;
      background:#0f1118;
      border-radius: 12px;
      margin:8px 0;
    }
    .fileName{ font-weight:650; font-size:13px; }
    .fileMeta{ font-size:12px; color:var(--muted2); margin-top:4px; }
    .miniBtn{
      border:1px solid var(--border);
      background:#0b0d14;
      color:var(--text);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      height: fit-content;
      white-space:nowrap;
    }
    .miniBtn:hover{ border-color:#3a4490; }
    .footerLine{
      max-width: 920px;
      margin:10px auto 0;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:var(--muted2);
      font-size:12px;
      padding:0 2px;
    }
  </style>
</head>

<body>
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">C</div>
      <div>
        <div class="title">Claude Proxy UI</div>
        <div class="sub">single-file ‚Ä¢ local</div>
      </div>
    </div>

    <button class="btn" id="newChatBtn">+ New chat</button>

    <div class="search">
      <span style="color:var(--muted2); font-size:12px;">üîé</span>
      <input id="searchChats" placeholder="Search chats..." />
    </div>

    <div class="sectionLabel">Chats</div>
    <div class="chatList" id="chatList"></div>

    <div class="sectionLabel">Status</div>
    <div class="pill"><span id="statusDot">‚óè</span><span id="statusText">Idle</span></div>
    <div class="small" id="usageText" style="margin-top:8px;"></div>

    <div class="hr"></div>

    <button class="btn secondary" id="exportBtn">Export chat (.json)</button>
    <button class="btn danger" id="clearAllBtn">Delete all chats</button>

    <div class="small" style="margin-top:10px;">
      Tip: serve this file via a local web server (not <code>file://</code>) to avoid CORS/fetch issues.
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="topbarLeft">
        <div class="topTitle" id="activeChatTitle">New chat</div>
        <div class="topSub">Local proxy at <code id="topProxy">http://localhost:8080</code></div>
      </div>

      <div class="settingsRow">
        <div class="field">
          <label>Proxy Base URL</label>
          <input id="baseUrl" value="http://localhost:8080" />
        </div>
        <div class="field">
          <label>x-api-key (placeholder is fine)</label>
          <input id="apiKey" value="local-placeholder-key" />
        </div>
      </div>
    </div>

    <section class="chat" id="chatView"></section>

    <div class="composerWrap">
      <div class="composer">
        <button class="attachBtn" id="attachBtn" title="Attach files">+</button>
        <textarea id="prompt" placeholder="Message Claude‚Ä¶"></textarea>

        <div class="composerRight">
          <select class="modelSelect" id="model">
            <option value="claude-opus-4-5-thinking">Opus 4.5</option>
            <option value="claude-sonnet-4-5">Sonnet 4.5</option>
            <option value="claude-haiku-4-5-20251001">Haiku 4.5</option>
            <option value="__custom__">Custom‚Ä¶</option>
          </select>
          <button class="sendBtn" id="sendBtn" title="Send">‚Üë</button>
        </div>
      </div>

      <div class="attachPanel" id="attachPanel">
        <div class="small">Attach images, PDFs, DOCX. PDF/DOCX text is extracted locally in your browser.</div>
        <input id="filePicker" type="file" multiple
          accept="image/*,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
          style="margin-top:10px;" />
        <div id="fileList"></div>
      </div>

      <div class="footerLine">
        <div id="hintText">Enter to send ‚Ä¢ Shift+Enter for new line</div>
        <div id="debugHint"></div>
      </div>
    </div>
  </main>
</div>

<script>
  // -----------------------------
  // Utilities
  // -----------------------------
  const $ = (id) => document.getElementById(id);

  function nowIso(){ return new Date().toISOString(); }

  function setStatus(state, kind="idle"){
    $("statusText").textContent = state;
    const dot = $("statusDot");
    dot.style.color = (kind==="ok") ? "#45c17c" : (kind==="err") ? "#b54b5a" : "#aab1d2";
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function arrayBufferToBase64(buf) {
    let binary = "";
    const bytes = new Uint8Array(buf);
    const chunk = 0x8000;
    for (let i = 0; i < bytes.length; i += chunk) {
      binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
    }
    return btoa(binary);
  }

  function guessImageMediaType(file) {
    const t = (file.type || "").toLowerCase();
    if (t) return t;
    const name = file.name.toLowerCase();
    if (name.endsWith(".png")) return "image/png";
    if (name.endsWith(".jpg") || name.endsWith(".jpeg")) return "image/jpeg";
    if (name.endsWith(".webp")) return "image/webp";
    if (name.endsWith(".gif")) return "image/gif";
    return "image/png";
  }

  // -----------------------------
  // PDF / DOCX extraction
  // -----------------------------
  async function extractPdfText(file) {
    const buf = await file.arrayBuffer();
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.worker.min.js";
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

    let out = "";
    const maxPages = Math.min(pdf.numPages, 50);
    for (let p = 1; p <= maxPages; p++) {
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const strings = content.items.map(it => it.str).filter(Boolean);
      out += `\n\n--- Page ${p} ---\n` + strings.join(" ");
    }
    if (pdf.numPages > maxPages) out += `\n\n[Truncated: first ${maxPages} pages only]`;
    return out.trim();
  }

  async function extractDocxText(file) {
    const buf = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer: buf });
    return (result.value || "").trim();
  }

  // -----------------------------
  // Storage (local only)
  // -----------------------------
  const STORE_KEY = "claude_proxy_ui_chats_v1";

  function loadChats(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    }catch{ return []; }
  }
  function saveChats(){
    localStorage.setItem(STORE_KEY, JSON.stringify(chats));
  }

  // Chat format:
  // { id, title, createdAt, updatedAt, model, messages:[{role, contentBlocks, createdAt}] }
  let chats = loadChats();
  let activeChatId = chats[0]?.id || null;

  function newChat(){
    const id = crypto.randomUUID();
    const chat = {
      id,
      title: "New chat",
      createdAt: nowIso(),
      updatedAt: nowIso(),
      model: "claude-opus-4-5-thinking",
      messages: []
    };
    chats.unshift(chat);
    activeChatId = id;
    saveChats();
    renderSidebar();
    renderChat();
  }

  function getActiveChat(){
    return chats.find(c => c.id === activeChatId) || null;
  }

  function setActiveChat(id){
    activeChatId = id;
    saveChats();
    renderSidebar();
    renderChat();
  }

  function deleteAllChats(){
    if(!confirm("Delete all chats?")) return;
    chats = [];
    activeChatId = null;
    saveChats();
    renderSidebar();
    renderChat();
  }

  function exportActiveChat(){
    const chat = getActiveChat();
    if(!chat) return alert("No chat to export.");
    const blob = new Blob([JSON.stringify(chat, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${chat.title.replace(/[^\w\-]+/g,"_") || "chat"}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // -----------------------------
  // Attachments for current message (not stored)
  // -----------------------------
  let attached = []; // {file, kind, base64?, mediaType?, extractedText?}

  async function addFiles(fileList){
    const files = Array.from(fileList || []);
    for(const f of files){
      const type = (f.type || "").toLowerCase();
      if(type.startsWith("image/")){
        const buf = await f.arrayBuffer();
        attached.push({
          file:f,
          kind:"image",
          mediaType: guessImageMediaType(f),
          base64: arrayBufferToBase64(buf)
        });
      }else if(type === "application/pdf" || f.name.toLowerCase().endsWith(".pdf")){
        const item = { file:f, kind:"pdf", extractedText:"" };
        attached.push(item);
        renderFiles();
        try { item.extractedText = await extractPdfText(f); }
        catch(e){ item.extractedText = `[PDF extraction failed: ${e?.message||e}]`; }
      }else if(
        type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document" ||
        f.name.toLowerCase().endsWith(".docx")
      ){
        const item = { file:f, kind:"docx", extractedText:"" };
        attached.push(item);
        renderFiles();
        try { item.extractedText = await extractDocxText(f); }
        catch(e){ item.extractedText = `[DOCX extraction failed: ${e?.message||e}]`; }
      }else{
        attached.push({ file:f, kind:"unsupported", extractedText:"[Unsupported file type]" });
      }
      renderFiles();
    }
  }

  function clearAttachments(){
    attached = [];
    renderFiles();
  }

  function renderFiles(){
    const list = $("fileList");
    if(!attached.length){
      list.innerHTML = `<div class="small" style="margin-top:10px;">No files attached.</div>`;
      return;
    }
    list.innerHTML = "";
    attached.forEach((a, idx) => {
      const row = document.createElement("div");
      row.className = "fileRow";
      const left = document.createElement("div");
      const right = document.createElement("div");
      left.innerHTML = `
        <div class="fileName">${a.file.name}</div>
        <div class="fileMeta">
          ${a.kind.toUpperCase()} ‚Ä¢ ${(a.file.size/1024).toFixed(1)} KB
          ${a.kind !== "image" ? (a.extractedText ? " ‚Ä¢ text extracted" : " ‚Ä¢ extracting‚Ä¶") : ""}
        </div>
      `;
      const btn = document.createElement("button");
      btn.className = "miniBtn";
      btn.textContent = "Remove";
      btn.onclick = () => {
        attached.splice(idx,1);
        renderFiles();
      };
      right.appendChild(btn);
      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);
    });
  }

  // -----------------------------
  // Rendering
  // -----------------------------
  function renderSidebar(){
    const list = $("chatList");
    const q = ($("searchChats").value || "").toLowerCase();
    list.innerHTML = "";
    const filtered = chats.filter(c => (c.title||"").toLowerCase().includes(q));
    if(!filtered.length){
      list.innerHTML = `<div class="small" style="padding:10px 8px;">No chats.</div>`;
      return;
    }
    for(const c of filtered){
      const div = document.createElement("div");
      div.className = "chatItem" + (c.id===activeChatId ? " active":"");
      div.onclick = () => setActiveChat(c.id);
      const last = c.messages?.slice(-1)[0];
      const meta = last ? (last.role + " ‚Ä¢ " + new Date(c.updatedAt).toLocaleString()) : ("No messages yet");
      div.innerHTML = `
        <div class="chatTitle">${escapeHtml(c.title || "Untitled")}</div>
        <div class="chatMeta">${escapeHtml(meta)}</div>
      `;
      list.appendChild(div);
    }
  }

  function renderChat(){
    const chat = getActiveChat();
    $("activeChatTitle").textContent = chat?.title || "New chat";
    $("topProxy").textContent = ($("baseUrl").value || "http://localhost:8080").trim();
    $("chatView").innerHTML = "";

    // Set model dropdown to chat's model
    if(chat?.model){
      const known = ["claude-opus-4-5-thinking","claude-sonnet-4-5","claude-haiku-4-5-20251001"];
      if(known.includes(chat.model)){
        $("model").value = chat.model;
      }else{
        $("model").value = "__custom__";
      }
    }

    if(!chat || chat.messages.length === 0){
      const empty = document.createElement("div");
      empty.className = "bubble assistant";
      empty.innerHTML = `
        <div class="meta"><span>CLAUDE</span><span style="color:var(--muted2)">ready</span></div>
        Hey there ‚Äî attach a file or ask a question.
      `;
      $("chatView").appendChild(empty);
      return;
    }

    for(const m of chat.messages){
      const b = document.createElement("div");
      b.className = "bubble " + (m.role==="user" ? "user":"assistant");
      const who = m.role==="user" ? "YOU" : "CLAUDE";
      const t = new Date(m.createdAt).toLocaleTimeString();
      const txt = contentBlocksToText(m.contentBlocks || []);
      b.innerHTML = `
        <div class="meta"><span>${who}</span><span>${t}</span></div>
        ${formatText(txt)}
      `;
      $("chatView").appendChild(b);
    }

    $("chatView").scrollTop = $("chatView").scrollHeight;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function formatText(text){
    // Tiny formatter: code fences -> <pre>
    const parts = String(text).split("```");
    if(parts.length === 1) return escapeHtml(text);
    let out = "";
    for(let i=0;i<parts.length;i++){
      if(i%2===0){
        out += escapeHtml(parts[i]);
      }else{
        // strip optional language line
        const seg = parts[i];
        const nl = seg.indexOf("\n");
        const code = nl >= 0 ? seg.slice(nl+1) : seg;
        out += `<div class="code"><pre style="margin:0; white-space:pre-wrap;">${escapeHtml(code)}</pre></div>`;
      }
    }
    return out;
  }

  function contentBlocksToText(blocks){
    let txt = "";
    for(const b of blocks){
      if(b.type === "text") txt += b.text;
      else if(b.type === "image") txt += "\n[Image attached]\n";
    }
    return txt.trim();
  }

  // -----------------------------
  // Build user content blocks for API
  // -----------------------------
  function buildUserContentBlocks(userText){
    const blocks = [];

    // images as image blocks
    for(const a of attached){
      if(a.kind==="image" && a.base64){
        blocks.push({
          type:"image",
          source:{
            type:"base64",
            media_type: a.mediaType || "image/png",
            data: a.base64
          }
        });
      }
    }

    // docs as extracted text
    const docTexts = [];
    for(const a of attached){
      if((a.kind==="pdf" || a.kind==="docx" || a.kind==="unsupported") && a.extractedText){
        const header = a.kind==="pdf" ? "PDF" : (a.kind==="docx" ? "DOCX" : "FILE");
        docTexts.push(`### ${header}: ${a.file.name}\n${a.extractedText}`);
      }
    }
    if(docTexts.length){
      blocks.push({
        type:"text",
        text: `Attached document text (extracted locally in the browser):\n\n${docTexts.join("\n\n")}\n\n--- End extracted text ---`
      });
    }

    blocks.push({ type:"text", text: userText });
    return blocks;
  }

  // -----------------------------
  // API call
  // -----------------------------
  async function sendMessage(){
    const baseUrl = ($("baseUrl").value || "").trim().replace(/\/+$/,"");
    const apiKey  = ($("apiKey").value || "").trim();
    const modelSel = $("model").value;

    let model = modelSel;
    if(modelSel === "__custom__"){
      model = prompt("Enter model name exactly:", "claude-opus-4-5-thinking") || "";
      model = model.trim();
      if(!model) return;
    }

    const promptEl = $("prompt");
    const userText = (promptEl.value || "").trim();
    if(!userText && attached.length===0){
      alert("Type a message or attach a file.");
      return;
    }
    if(!baseUrl){
      alert("Proxy Base URL is required (e.g. http://localhost:8080).");
      return;
    }

    // Ensure chat exists
    if(!activeChatId) newChat();
    const chat = getActiveChat();

    // store chat model
    chat.model = model;

    // Append user message to local history
    const userBlocks = buildUserContentBlocks(userText || "(no text)");
    chat.messages.push({ role:"user", contentBlocks:userBlocks, createdAt: nowIso() });

    // Basic title inference
    if(chat.title === "New chat"){
      chat.title = (userText || attached?.[0]?.file?.name || "Chat").slice(0, 48);
    }
    chat.updatedAt = nowIso();

    // Build API payload
    const payload = {
      model,
      max_tokens: 900,
      messages: chat.messages.map(m => ({
        role: m.role,
        content: m.contentBlocks
      }))
    };

    // UI state
    $("sendBtn").disabled = true;
    setStatus("Sending‚Ä¶");
    $("usageText").textContent = "";

    try{
      const res = await fetch(`${baseUrl}/v1/messages`, {
        method:"POST",
        headers:{
          "content-type":"application/json",
          "x-api-key": apiKey || "local-placeholder-key",
          "anthropic-version":"2023-06-01"
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(()=> ({}));
      if(!res.ok){
        setStatus(`Error (${res.status})`, "err");
        $("debugHint").textContent = `Last error: ${data?.error?.message || JSON.stringify(data)}`;
        return;
      }

      let assistantText = "";
      if(Array.isArray(data.content)){
        for(const b of data.content){
          if(b.type==="text" && typeof b.text === "string") assistantText += b.text;
        }
      }
      chat.messages.push({
        role:"assistant",
        contentBlocks:[{type:"text", text: assistantText || "[No text returned]"}],
        createdAt: nowIso()
      });
      chat.updatedAt = nowIso();

      if(data.usage){
        $("usageText").textContent = `input_tokens: ${data.usage.input_tokens ?? "?"} ‚Ä¢ output_tokens: ${data.usage.output_tokens ?? "?"}`;
      }

      setStatus("Done", "ok");
      $("debugHint").textContent = "";
      promptEl.value = "";
      clearAttachments();
      saveChats();
      renderSidebar();
      renderChat();
    }catch(e){
      setStatus("Request failed", "err");
      $("debugHint").textContent = `Fetch failed: ${e?.message || e}`;
    }finally{
      $("sendBtn").disabled = false;
    }
  }

  // -----------------------------
  // Events
  // -----------------------------
  $("newChatBtn").addEventListener("click", newChat);
  $("clearAllBtn").addEventListener("click", deleteAllChats);
  $("exportBtn").addEventListener("click", exportActiveChat);

  $("searchChats").addEventListener("input", renderSidebar);

  $("attachBtn").addEventListener("click", () => {
    $("attachPanel").classList.toggle("show");
  });

  $("filePicker").addEventListener("change", async (e) => {
    await addFiles(e.target.files);
    e.target.value = "";
    $("attachPanel").classList.add("show");
  });

  $("sendBtn").addEventListener("click", sendMessage);

  // Enter to send, Shift+Enter newline
  $("prompt").addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  // textarea auto-grow
  $("prompt").addEventListener("input", () => {
    const el = $("prompt");
    el.style.height = "auto";
    el.style.height = clamp(el.scrollHeight, 44, 160) + "px";
  });

  $("baseUrl").addEventListener("input", () => {
    $("topProxy").textContent = ($("baseUrl").value || "").trim();
  });

  // Init
  if(!activeChatId && chats.length) activeChatId = chats[0].id;
  if(!activeChatId) newChat();
  else { renderSidebar(); renderChat(); }
  renderFiles();
  setStatus("Idle");
</script>
</body>
</html>
